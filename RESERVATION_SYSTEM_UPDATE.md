# 予約システム改善完了レポート

## 📋 実装概要

予約システムのフローを改善し、以下の機能を実装しました：

1. **募集人数の管理機能**
2. **スタッフアサイン機能（後からアサイン可能）**
3. **社員向け予約登録画面の満席判定**

---

## ✅ 実装内容

### 1. バックエンドの変更

#### データベースモデル（`backend/app/models/reservation.py`）
- **追加フィールド**: `max_participants` (Integer, デフォルト: 1)
  - 募集人数を管理

#### スキーマ（`backend/app/schemas/reservation.py`）
- `ReservationBase`, `ReservationUpdate` に `max_participants` を追加

#### マイグレーション
- ✅ `add_max_participants.py` でデータベースにカラムを追加済み

---

### 2. フロントエンドの変更

#### **① 予約作成画面**（`frontend/src/app/admin/reservations/new/page.tsx`）

**変更前**:
```typescript
// スタッフ・社員情報セクション
- 担当スタッフ入力欄
- 対象社員入力欄
```

**変更後**:
```typescript
// 募集情報セクション
- 募集人数入力欄 (必須, 1〜50名)
- 説明: スタッフは後からアサイン可能、社員は各自が登録
```

**画面イメージ**:
```
┌──────────────────────────────────────────┐
│ 募集情報                                 │
├──────────────────────────────────────────┤
│ 募集人数 *                               │
│ [  3  ] 名                               │
│ マッサージを受ける社員の募集人数を       │
│ 指定してください                         │
│                                          │
│ ℹ️ スタッフと社員の指定について          │
│ 担当スタッフは予約作成後に管理画面から   │
│ アサインできます。                       │
│ 社員は各自が予約登録画面から登録します。 │
└──────────────────────────────────────────┘
```

---

#### **② 予約詳細画面**（`frontend/src/app/admin/reservations/[id]/page.tsx`）

**新機能: スタッフアサインモーダル**

**画面イメージ**:
```
┌──────────────────────────────────────────┐
│ スタッフ・社員情報       [スタッフをアサイン]│
├──────────────────────────────────────────┤
│ 担当スタッフ                             │
│ [山田花子] [佐藤美咲]                    │
│                                          │
│ 対象社員 [2 / 3名]                      │
│ [田中部長] [鈴木課長]                    │
│                                          │
│ (まだ1名の空きがあります)               │
└──────────────────────────────────────────┘
```

**「スタッフをアサイン」ボタンをクリック**:
```
┌────────────────────────────────────────────────┐
│ スタッフをアサイン                        [X]   │
├────────────────────────────────────────────────┤
│ ℹ️ 訪問する施術スタッフを選択してください     │
│   複数選択可能です。                           │
│                                                │
│ ┌──────────────┐  ┌──────────────┐           │
│ │ 👤 山田花子  │  │ 👤 佐藤美咲  │ ✓         │
│ │ ID: 1        │  │ ID: 2        │           │
│ └──────────────┘  └──────────────┘           │
│                                                │
│ ┌──────────────┐  ┌──────────────┐           │
│ │ 👤 鈴木健太  │  │ 👤 高橋愛    │           │
│ │ ID: 3        │  │ ID: 4        │           │
│ └──────────────┘  └──────────────┘           │
│                                                │
│ ✅ 選択中のスタッフ (2名):                     │
│    [山田花子] [佐藤美咲]                       │
│                                                │
│ [キャンセル]        [アサインする (2名)]       │
└────────────────────────────────────────────────┘
```

**実装機能**:
- ✅ スタッフ一覧表示（モックデータ）
- ✅ 複数選択可能
- ✅ 既にアサインされているスタッフは選択済み状態
- ✅ 選択したスタッフをアサイン（`staff_names` 更新）

---

#### **③ 社員向け予約登録画面**（`frontend/src/app/company/employee-bookings/page.tsx`）

**新機能: 募集人数・満席判定**

**画面イメージ（募集中）**:
```
┌──────────────────────────────────────────┐
│ 本社オフィス                  [募集中]   │
│ 予約ID: 1                                │
├──────────────────────────────────────────┤
│ 📅 訪問日時    👥 募集人数               │
│ 2026/01/15      2 / 3名 (空き1名)       │
│ 10:00〜12:00                             │
│                                          │
│ 📍 場所                                  │
│ 大阪府大阪市北区梅田1-1-1                │
│                                          │
│ ✅ 既に登録されている社員:               │
│    田中部長, 鈴木課長                    │
│                                          │
│ [詳細を見る]        [登録する]          │
└──────────────────────────────────────────┘
```

**画面イメージ（満席）**:
```
┌──────────────────────────────────────────┐
│ 本社オフィス                    [満席]   │
│ 予約ID: 2                                │
├──────────────────────────────────────────┤
│ 📅 訪問日時    👥 募集人数               │
│ 2026/01/20      1 / 1名                  │
│ 14:00〜16:00                             │
│                                          │
│ 📍 場所                                  │
│ 大阪府大阪市北区梅田1-1-1                │
│                                          │
│ ✅ 既に登録されている社員:               │
│    佐藤主任                              │
│                                          │
│ [詳細を見る]                             │
│ (登録ボタン非表示)                       │
└──────────────────────────────────────────┘
```

**実装機能**:
- ✅ 募集人数 / 登録済み人数の表示
- ✅ 空き人数の表示（募集中の場合のみ）
- ✅ 満席判定（`registeredCount >= max_participants`）
- ✅ 満席時の動作:
  - カード背景を灰色に変更
  - 「満席」バッジを表示
  - 「登録する」ボタンを非表示

---

## 📊 データフロー

### 予約作成から完了までの流れ

```
┌─────────────────────────────────────────────────────────┐
│ 1. オリエンタルシナジーが予約作成                      │
│    - 企業、事業所、日時を指定                           │
│    - 募集人数を設定（例: 3名）                          │
│    - スタッフ: 未アサイン                               │
│    - 社員: 0名                                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 2. 企業側管理者が予約を確認                            │
│    - 予約一覧で確認                                     │
│    - 社員にLINE/メールで通知                            │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 3. 社員が予約登録画面で登録                            │
│    - 予約一覧を表示: 募集人数 0 / 3名（空き3名）       │
│    - 田中部長が登録 → 1 / 3名（空き2名）               │
│    - 鈴木課長が登録 → 2 / 3名（空き1名）               │
│    - 佐藤主任が登録 → 3 / 3名（満席）                  │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 4. オリエンタルシナジーがスタッフをアサイン            │
│    - 予約詳細画面を開く                                 │
│    - 「スタッフをアサイン」ボタンをクリック             │
│    - スタッフ選択モーダルで山田花子、佐藤美咲を選択     │
│    - アサイン完了                                       │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 5. 業務実施                                             │
│    - スタッフが企業に訪問                               │
│    - 田中部長、鈴木課長、佐藤主任に施術                 │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 テストシナリオ

### シナリオ1: 募集人数3名の予約作成

1. 管理画面で「新規予約作成」
2. 企業を選択（株式会社A）
3. 事業所名: 本社オフィス
4. 日時: 2026/01/15 10:00〜12:00
5. **募集人数: 3名**
6. 予約作成完了

**期待結果**:
- ✅ 予約が作成される
- ✅ `max_participants = 3`
- ✅ `staff_names = null`（未アサイン）
- ✅ `employee_names = null`（登録なし）

---

### シナリオ2: 社員が予約に登録

1. 社員用予約登録画面を開く
2. 予約ID: 1を確認
3. 募集人数: 0 / 3名（空き3名）表示
4. 「登録する」ボタンをクリック
5. 社員名: 田中部長、部署: 総務部を入力
6. 登録完了

**期待結果**:
- ✅ `employee_names = "田中部長"`
- ✅ 募集人数: 1 / 3名（空き2名）に更新
- ✅ 「募集中」バッジ表示

---

### シナリオ3: 満席判定

1. 2名目の社員が登録（鈴木課長）
2. 3名目の社員が登録（佐藤主任）
3. 社員用予約登録画面を確認

**期待結果**:
- ✅ 募集人数: 3 / 3名（満席）表示
- ✅ 「満席」バッジ表示
- ✅ 「登録する」ボタン非表示
- ✅ カード背景が灰色

---

### シナリオ4: スタッフアサイン

1. 管理画面で予約詳細を開く
2. 「スタッフをアサイン」ボタンをクリック
3. 山田花子、佐藤美咲を選択
4. 「アサインする (2名)」ボタンをクリック

**期待結果**:
- ✅ `staff_names = "山田花子, 佐藤美咲"`
- ✅ 担当スタッフが表示される
- ✅ ステータスが「確定」に変更可能

---

## 📁 変更ファイル一覧

### バックエンド

- ✅ `backend/app/models/reservation.py` - `max_participants`追加
- ✅ `backend/app/schemas/reservation.py` - スキーマ更新
- ✅ `backend/add_max_participants.py` - マイグレーションスクリプト（実行済み）

### フロントエンド

- ✅ `frontend/src/lib/api.ts` - `Reservation`, `ReservationCreate` に `max_participants` 追加
- ✅ `frontend/src/app/admin/reservations/new/page.tsx` - 募集人数欄追加、スタッフ・社員欄削除
- ✅ `frontend/src/app/admin/reservations/[id]/page.tsx` - スタッフアサイン機能追加
- ✅ `frontend/src/app/company/employee-bookings/page.tsx` - 募集人数表示、満席判定追加

---

## 🚀 動作確認

### 1. バックエンド（既に起動中）
```bash
cd /Users/soedakei/madoc_line/backend
source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. フロントエンド（既に起動中）
```bash
cd /Users/soedakei/madoc_line/frontend
npm run dev
```

### 3. 確認URL

#### 管理画面
- 予約作成: http://localhost:3000/admin/reservations/new
- 予約一覧: http://localhost:3000/admin/reservations
- 予約詳細: http://localhost:3000/admin/reservations/1

#### 社員向け
- 予約登録: http://localhost:3000/company/employee-bookings

---

## 📝 注意事項

### モックデータの制限

現在はモックデータを使用しているため、以下の点に注意：

1. **スタッフアサイン**
   - モックスタッフ: 山田花子、佐藤美咲、鈴木健太、高橋愛、田中太郎
   - 実際のスタッフAPIは未実装

2. **社員登録**
   - 重複登録チェックは実装済み
   - ただし、ページリロード時にモックデータに戻る

3. **認証**
   - 認証機能は未実装
   - 全画面がフリーアクセス

---

## 🎯 今後の拡張予定

### 優先度: 高

1. **スタッフAPI実装**
   - スタッフ一覧取得API
   - スタッフ詳細API
   - スキル・資格情報

2. **認証機能実装**
   - JWT認証
   - ロール管理
   - セッション管理

3. **通知機能**
   - LINE通知
   - メール通知
   - 社員への予約通知

### 優先度: 中

4. **予約の自動確定**
   - 募集人数が埋まったら自動確定
   - スタッフがアサインされたら確定

5. **予約のキャンセル待ち**
   - 満席時のキャンセル待ちリスト
   - キャンセル時の自動通知

---

## ✅ 完了チェックリスト

- [x] バックエンドモデルに `max_participants` フィールド追加
- [x] マイグレーションスクリプト実行
- [x] 予約作成画面から担当スタッフ・対象社員欄を削除
- [x] 予約作成画面に募集人数欄を追加
- [x] 予約詳細画面にスタッフアサイン機能を追加
- [x] 社員向け予約登録画面に募集人数表示を追加
- [x] 社員向け予約登録画面に満席判定を追加
- [x] リンターエラーなし

---

**実装完了日**: 2026年1月8日
**バージョン**: v1.1.0
**実装者**: AI Assistant








