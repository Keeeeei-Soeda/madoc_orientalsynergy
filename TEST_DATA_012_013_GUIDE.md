# テストデータ012、013 - テストガイド

## 作成日: 2026年1月23日

## テストデータの概要

### 予約012: 札幌支店（テスト012）

- **予約ID**: 42
- **実施場所**: 札幌支店（テスト012）
- **住所**: 北海道札幌市中央区北1条西2-2-2
- **日時**: 2026/02/01 12:00〜14:00
- **募集人数**: 3名
- **予約済み**: 1名（田中太郎 - 営業部）
- **空き枠**: 2名
- **ステータス**: 募集中

#### 時間枠の詳細

| 枠番号 | 時間 | 施術時間 | 状態 | 登録者 |
|--------|------|---------|------|--------|
| 枠1 | 12:00〜12:30 | 30分 | ✅ 予約済み | 田中太郎（営業部） |
| 枠2 | 12:40〜13:10 | 30分 | ⚪ 空き | - |
| 枠3 | 13:20〜13:50 | 30分 | ⚪ 空き | - |

**休憩時間**: 各枠の間に10分

---

### 予約013: 仙台支店（テスト013）

- **予約ID**: 43
- **実施場所**: 仙台支店（テスト013）
- **住所**: 宮城県仙台市青葉区中央1-1-1
- **日時**: 2026/02/02 12:00〜14:00
- **募集人数**: 3名
- **予約済み**: 1名（佐藤花子 - 総務部）
- **空き枠**: 2名
- **ステータス**: 募集中

#### 時間枠の詳細

| 枠番号 | 時間 | 施術時間 | 状態 | 登録者 |
|--------|------|---------|------|--------|
| 枠1 | 12:00〜12:30 | 30分 | ✅ 予約済み | 佐藤花子（総務部） |
| 枠2 | 12:40〜13:10 | 30分 | ⚪ 空き | - |
| 枠3 | 13:20〜13:50 | 30分 | ⚪ 空き | - |

**休憩時間**: 各枠の間に10分

---

## テストシナリオ

このテストデータを使用して、以下の3つの予約パターンをテストできます。

### パターン① スタッフが枠に申し込む

**目的**: スタッフ側から予約に応募する流れをテスト

**手順:**
1. スタッフアカウントでログイン
   - URL: `http://localhost:3000/staff/login`
   
2. スタッフダッシュボードにアクセス
   - URL: `http://localhost:3000/staff/dashboard`
   
3. 「募集中の案件」から予約012または013を選択
   
4. 時間枠を選択して応募
   - 枠2（12:40〜13:10）または
   - 枠3（13:20〜13:50）
   
5. 応募完了を確認

**または、管理者側からスタッフをアサイン:**

1. 管理者アカウントでログイン
   - URL: `http://localhost:3000/admin/login`
   
2. 管理者ダッシュボードから予約一覧を開く
   - URL: `http://localhost:3000/admin/dashboard`
   
3. 予約012（ID: 42）または予約013（ID: 43）の詳細を開く
   
4. 「スタッフをアサイン」ボタンをクリック
   
5. スタッフを選択し、空き枠（枠2または枠3）に割り当て

**期待結果:**
- ✅ スタッフが指定した枠に割り当てられる
- ✅ 枠の`is_filled`が`true`になる
- ✅ 予約のステータスが更新される（必要に応じて）

---

### パターン② 社員が自分で予約する（ボトムアップ方式）

**目的**: 社員が自分で時間枠を選択して予約登録する流れをテスト

**手順:**
1. 企業アカウントでログイン
   - URL: `http://localhost:3000/company/login`
   - ユーザー名: 企業アカウント
   
2. 社員用予約登録ページにアクセス
   - URL: `http://localhost:3000/company/employee-bookings`
   
3. 募集中の予約一覧から予約012または013を選択
   - 「時間枠を選択して登録する」ボタンをクリック
   
4. 予約詳細モーダルで空き枠を選択
   - 枠2（12:40〜13:10）または
   - 枠3（13:20〜13:50）を選択
   
5. 「選択した枠で登録手続きへ進む」ボタンをクリック
   
6. 登録フォームに社員情報を入力
   - 社員名: 例）鈴木次郎
   - 部署: 例）開発部
   - 役職: 例）主任（任意）
   - 電話番号: 例）090-1234-5678（任意）
   - メールアドレス: 例）suzuki@example.com（任意）
   - 備考: 例）肩こりがひどいです（任意）
   
7. 「登録する」ボタンをクリック

**期待結果:**
- ✅ 選択した枠に社員が割り当てられる
- ✅ 枠の`is_filled`が`true`になる
- ✅ `employee_names`に社員名が追加される
- ✅ `slots_filled`が増加する（1 → 2）
- ✅ 空き枠が減少する（2名 → 1名）
- ✅ 登録完了メッセージが表示される
- ✅ 予約一覧が更新される

---

### パターン③ 会社側で予約を取る（トップダウン方式）

**目的**: 企業管理者が社員マスタから社員を選択して枠に割り当てる流れをテスト

**手順:**
1. 企業アカウントでログイン
   - URL: `http://localhost:3000/company/login`
   
2. 予約一覧ページにアクセス
   - URL: `http://localhost:3000/company/reservations`
   
3. 予約012（ID: 42）または予約013（ID: 43）の「詳細」ボタンをクリック
   - URL: `http://localhost:3000/company/reservations/42` または `/43`
   
4. 予約詳細ページで時間枠一覧を確認
   
5. 空き枠（枠2または枠3）の「社員を割り当て」ボタンをクリック
   
6. 社員選択モーダルから社員を選択
   - 社員マスタに登録されている社員を選択
   - 例）山田太郎、田中花子など
   
7. 「割り当て」ボタンをクリック

**期待結果:**
- ✅ 選択した社員が指定した枠に割り当てられる
- ✅ 枠の`is_filled`が`true`になる
- ✅ 枠に社員の名前と部署が表示される
- ✅ `slots_filled`が増加する
- ✅ 空き枠が減少する
- ✅ ページが自動的に更新される

---

## 混在シナリオのテスト

3つのパターンを組み合わせてテストすることも可能です。

### シナリオ例: 予約012で3パターンすべてをテスト

1. **初期状態**
   - 枠1: 田中太郎（営業部）- 既に登録済み
   - 枠2: 空き
   - 枠3: 空き
   
2. **パターン②を実行**（社員が自分で予約）
   - 鈴木次郎（開発部）が枠2（12:40〜13:10）に登録
   
3. **結果**
   - 枠1: 田中太郎（営業部）
   - 枠2: 鈴木次郎（開発部）✨ 新規登録
   - 枠3: 空き
   
4. **パターン③を実行**（会社側で予約）
   - 管理者が山田太郎（総務部）を枠3（13:20〜13:50）に割り当て
   
5. **最終結果**
   - 枠1: 田中太郎（営業部）- 初期データ
   - 枠2: 鈴木次郎（開発部）- 社員が自己登録
   - 枠3: 山田太郎（総務部）- 管理者が割り当て
   - **満席** - 空き枠0名

6. **確認事項**
   - ✅ `slots_filled` = 3
   - ✅ `max_participants` = 3
   - ✅ 空き枠 = 0
   - ✅ すべての枠が`is_filled = true`
   - ✅ 募集中の予約一覧に表示されない（満席のため）

---

## データの整合性確認

テスト後、以下のコマンドでデータの整合性を確認できます：

```bash
cd /Users/soedakei/madoc_line/backend
source venv/bin/activate
python3 << 'EOF'
import sqlite3
import json

conn = sqlite3.connect('oriental_synergy.db')
cursor = conn.cursor()

cursor.execute("""
    SELECT id, office_name, max_participants, slots_filled, employee_names, time_slots
    FROM reservations 
    WHERE id IN (42, 43)
""")

for row in cursor.fetchall():
    rid, name, max_p, filled, emp_names, ts_json = row
    time_slots = json.loads(ts_json)
    if isinstance(time_slots, str):
        time_slots = json.loads(time_slots)
    
    emp_count = len(emp_names.split(',')) if emp_names else 0
    filled_count = sum(1 for s in time_slots if s.get('is_filled', False))
    
    print(f"\n予約ID {rid}: {name}")
    print(f"  max_participants: {max_p}")
    print(f"  slots_filled: {filled}")
    print(f"  employee_names数: {emp_count}")
    print(f"  is_filled=True枠数: {filled_count}")
    print(f"  整合性: {'✅ OK' if filled == emp_count == filled_count else '❌ NG'}")

conn.close()
EOF
```

---

## トラブルシューティング

### 問題1: 予約が表示されない

**原因**: ステータスが「募集中」でない可能性

**確認方法:**
```sql
SELECT id, office_name, status FROM reservations WHERE id IN (42, 43);
```

**解決方法:**
```sql
UPDATE reservations SET status = 'RECRUITING' WHERE id IN (42, 43);
```

### 問題2: 空き枠の表示がおかしい

**原因**: `slots_filled`と実際のデータが不一致

**解決方法:**
```bash
cd /Users/soedakei/madoc_line/backend
python fix_reservation_consistency.py
```

### 問題3: 時間枠が選択できない

**原因**: `is_filled`フラグが正しく設定されていない

**確認方法:**
```python
# time_slotsの内容を確認
SELECT id, time_slots FROM reservations WHERE id = 42;
```

**解決方法:**
```bash
cd /Users/soedakei/madoc_line/backend
python fix_time_slots_filled.py
```

---

## まとめ

### テストデータ012、013の特徴

✅ **募集人数**: 3名
✅ **予約済み**: 1名（社員が事前登録済み）
✅ **空き枠**: 2名
✅ **時間枠**: 3枠（30分×3、休憩10分）
✅ **テスト可能パターン**: スタッフ申し込み、社員自己登録、会社側割り当て
✅ **データ整合性**: 完全に保証

### 推奨テスト順序

1. まず予約012でパターン②（社員自己登録）をテスト
2. 次に予約012でパターン③（会社側割り当て）をテスト
3. 予約013でパターン①（スタッフ申し込み）をテスト
4. 最後に混在シナリオをテスト

---

**作成日**: 2026年1月23日
**テストデータID**: 42（札幌支店）、43（仙台支店）
**ステータス**: ✅ 準備完了

