# 予約フロー完全ガイド

## 📋 概要

このドキュメントは、オリエンタルシナジーのマッサージ派遣システムにおける予約フローの全体像を説明します。

---

## 🔄 予約フロー全体図

```
┌─────────────────────────────────────────────────────────────────────┐
│                    オリエンタルシナジー側                           │
├─────────────────────────────────────────────────────────────────────┤
│ ① 訪問日程登録 (/admin/reservations/new)                            │
│    - 企業を選択                                                      │
│    - 訪問日時を設定（事業所名、住所、日付、時間）                   │
│    - 要望・備考を入力                                                │
│    ↓                                                                 │
│ ② 情報提供 (/admin/reservations)                                    │
│    - 登録した予約を管理                                              │
│    - ステータス: pending（未確認）                                   │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         企業側（管理者）                             │
├─────────────────────────────────────────────────────────────────────┤
│ ③ 情報確認 (/company/reservations)                                  │
│    - オリエンタルシナジーが登録した予約を確認                       │
│    - 予約詳細を表示                                                  │
│    ↓                                                                 │
│ ④ 社員へ通達                                                         │
│    - 社員管理画面 (/company/employees) で社員一覧を確認             │
│    - メール、LINE、社内掲示板などで社員へ周知                       │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      企業側（社員個人）                              │
├─────────────────────────────────────────────────────────────────────┤
│ ⑤ 予約登録 (/company/employee-bookings) ★NEW★                      │
│    - 募集中の予約を一覧表示                                          │
│    - 各予約の詳細を確認（日時、場所、要望など）                     │
│    - 登録フォームに以下を入力:                                       │
│      * 社員名（必須）                                                │
│      * 部署（必須）                                                  │
│      * 役職（任意）                                                  │
│      * 電話番号（任意）                                              │
│      * メールアドレス（任意）                                        │
│      * 備考・要望（任意）                                            │
│    - 「登録する」ボタンをクリック                                    │
│    ↓                                                                 │
│ ⑥ 登録完了                                                           │
│    - 予約の employee_names フィールドに社員名が追加                 │
│    - ステータス: pending → confirmed (将来的に自動変更予定)          │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    オリエンタルシナジー側                           │
├─────────────────────────────────────────────────────────────────────┤
│ ⑦ 予約確認 (/admin/reservations)                                    │
│    - 社員が登録された予約を確認                                      │
│    - 登録された社員名を確認                                          │
│    - 必要に応じて社員情報を追加修正                                  │
│    ↓                                                                 │
│ ⑧ スタッフアサイン                                                   │
│    - スタッフ検索 (/admin/staff/search)                              │
│    - 適切なスタッフを選択してアサイン                                │
│    - ステータス: confirmed                                           │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      派遣スタッフ側                                  │
├─────────────────────────────────────────────────────────────────────┤
│ ⑨ 情報確認 (/staff/jobs)                                            │
│    - アサインされた業務を確認                                        │
│    - 業務詳細（日時、場所、企業情報、登録社員名）を表示             │
│    - オファー確認 (/staff/jobs/offers)                               │
│    ↓                                                                 │
│ ⑩ 受諾・辞退                                                         │
│    - 「受諾する」または「辞退する」を選択                           │
│    - 受諾 → 業務確定                                                 │
│    - 辞退 → 他のスタッフへ再アサイン                                │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         業務実施                                     │
├─────────────────────────────────────────────────────────────────────┤
│ ⑪ 派遣スタッフが企業に訪問                                           │
│    - 勤怠管理 (/admin/attendance) で出勤・退勤打刻                   │
│    - 登録された社員へマッサージ施術                                  │
│    - ステータス: confirmed → completed                               │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         評価・完了                                   │
├─────────────────────────────────────────────────────────────────────┤
│ ⑫ 企業側が評価入力 (/company/evaluations)                           │
│    - スタッフの技術、対応、清潔感などを評価                          │
│    - コメントを入力                                                  │
│    - ステータス: completed → evaluated                               │
│    ↓                                                                 │
│ ⑬ 完了                                                               │
│    - 評価データをスタッフプロフィールに反映                          │
│    - 次回の予約に向けてスタッフ検索の参考データとして活用           │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🎯 各ステップの詳細

### ① 訪問日程登録（オリエンタルシナジー）

**URL**: `/admin/reservations/new`

**実装状況**: ✅ 実装済み

**機能**:
- 企業一覧から企業を選択（company_idパラメータで事前選択も可能）
- 事業所名、住所を入力
- 訪問日付と時間（開始時刻・終了時刻）を設定
- 要望や備考を入力
- 「登録」ボタンで予約を作成

**関連ファイル**:
- `frontend/src/app/admin/reservations/new/page.tsx`
- `backend/app/api/v1/reservations.py` - `create_reservation()`

---

### ② 情報提供（オリエンタルシナジー）

**URL**: `/admin/reservations`

**実装状況**: ✅ 実装済み

**機能**:
- 予約一覧を表示
- ステータス別フィルター（pending, confirmed, completed, cancelled）
- 検索機能（事業所名）
- 予約詳細ページへのリンク

**関連ファイル**:
- `frontend/src/app/admin/reservations/page.tsx`
- `backend/app/api/v1/reservations.py` - `get_reservations()`

---

### ③ 情報確認（企業側管理者）

**URL**: `/company/reservations`

**実装状況**: ✅ 実装済み

**機能**:
- 自社の予約一覧を表示
- 予約詳細を確認（日時、スタッフ、登録済み社員など）
- ステータス別表示
- 募集ボタン（pending時）、評価入力ボタン（completed時）

**関連ファイル**:
- `frontend/src/app/company/reservations/page.tsx`
- `frontend/src/app/company/reservations/[id]/page.tsx`

---

### ④ 社員へ通達（企業側管理者）

**URL**: `/company/employees`

**実装状況**: ✅ 実装済み

**機能**:
- 社員一覧を表示
- LINE連携状況を確認
- 社員詳細モーダル
- LINE招待ボタン（未連携の社員向け）

**通達方法**:
- LINE通知（LINE連携済みの社員）
- メール通知（メールアドレス登録済みの社員）
- 社内掲示板、Slackなど（手動）

**関連ファイル**:
- `frontend/src/app/company/employees/page.tsx`

---

### ⑤ 予約登録（企業側社員個人）★NEW★

**URL**: `/company/employee-bookings`

**実装状況**: ✅ 新規実装完了！

**機能**:
- **募集中の予約を一覧表示**
  - 訪問日時、場所、要望を確認
  - 既に登録済みの社員数を表示
  - 登録済み社員名を表示（重複登録防止）

- **予約詳細を確認**
  - 「詳細を見る」ボタンでモーダル表示
  - 予約ID、事業所名、住所、日時、派遣スタッフ、要望、備考を確認

- **登録フォーム**
  - 社員名（必須）
  - 部署（必須）
  - 役職（任意）
  - 電話番号（任意）
  - メールアドレス（任意）
  - 備考・要望（任意）

- **登録処理**
  - `POST /reservations/{reservation_id}/employees` APIを呼び出し
  - 予約の `employee_names` フィールドに社員名を追加
  - 備考に社員情報（部署、役職、要望）を追記

**関連ファイル**:
- `frontend/src/app/company/employee-bookings/page.tsx` ★NEW★
- `backend/app/api/v1/reservations.py` - `add_employee_to_reservation()` ★NEW★
- `backend/app/schemas/reservation.py` - `EmployeeRegistration` ★NEW★
- `frontend/src/lib/api.ts` - `reservationsApi.addEmployee()` ★NEW★
- `frontend/src/components/layout/CompanySidebar.tsx` - メニュー追加 ★NEW★

---

### ⑥ 登録完了（企業側社員個人）

**実装状況**: ✅ 実装済み

**処理内容**:
1. 社員情報が予約の `employee_names` フィールドに追加される（カンマ区切り）
2. 備考に社員の部署、役職、要望が追記される
3. 登録完了メッセージが表示される
4. モーダルが自動的に閉じる

**重複登録チェック**:
- 既に同じ社員名が `employee_names` に含まれている場合、エラーを返す
- HTTP 400 Bad Request: "社員 'XXX' は既にこの予約に登録されています"

**データ例**:
```json
{
  "id": 1,
  "company_id": 1,
  "office_name": "本社オフィス",
  "reservation_date": "2026/01/15",
  "start_time": "10:00",
  "end_time": "12:00",
  "employee_names": "田中部長, 鈴木課長, 佐藤主任",
  "notes": "定期契約\n[社員登録] 田中部長 (総務部 - 部長) - 肩こりがひどいです\n[社員登録] 鈴木課長 (人事部 - 課長)\n[社員登録] 佐藤主任 (営業部 - 主任) - 腰痛あり",
  "status": "pending"
}
```

---

### ⑦ 予約確認（オリエンタルシナジー）

**URL**: `/admin/reservations`, `/admin/reservations/[id]`

**実装状況**: ✅ 実装済み

**機能**:
- 社員が登録された予約を一覧表示
- 予約詳細で登録された社員名（employee_names）を確認
- 必要に応じて予約情報を編集

**関連ファイル**:
- `frontend/src/app/admin/reservations/page.tsx`
- `frontend/src/app/admin/reservations/[id]/page.tsx`

---

### ⑧ スタッフアサイン（オリエンタルシナジー）

**URL**: `/admin/staff/search`

**実装状況**: ✅ 実装済み

**機能**:
- スタッフ検索（資格、対応可能日、評価、地域などでフィルター）
- スタッフプロフィール表示
- アサインボタン（将来実装予定）

**関連ファイル**:
- `frontend/src/app/admin/staff/search/page.tsx`

---

### ⑨ 情報確認（派遣スタッフ）

**URL**: `/staff/jobs`, `/staff/jobs/offers`

**実装状況**: ✅ 実装済み

**機能**:
- **業務一覧** (`/staff/jobs`)
  - アサインされた業務を一覧表示
  - ステータス別フィルター（募集中、確定、完了）
  - 業務詳細（日時、場所、企業情報、登録社員名）
  - 「応募する」ボタン

- **オファー確認** (`/staff/jobs/offers`)
  - オリエンタルシナジーから直接オファーされた業務を表示
  - オファー詳細（報酬、業務内容、備品、締切）
  - 「受諾する」「辞退する」ボタン

**関連ファイル**:
- `frontend/src/app/staff/jobs/page.tsx`
- `frontend/src/app/staff/jobs/offers/page.tsx`

---

### ⑩ 受諾・辞退（派遣スタッフ）

**実装状況**: 🔄 部分的実装（UIのみ、API未実装）

**機能**:
- 「受諾する」ボタン → 業務確定（status: confirmed）
- 「辞退する」ボタン → 他のスタッフへ再アサイン

**TODO**:
- アサイン管理API (`/api/v1/assignments`) の実装
- 受諾・辞退のバックエンド処理

---

### ⑪ 業務実施

**URL**: `/admin/attendance`

**実装状況**: ✅ 実装済み

**機能**:
- 出勤・退勤打刻
- 勤怠一覧表示
- 勤務時間計算

**関連ファイル**:
- `frontend/src/app/admin/attendance/page.tsx`
- `backend/app/api/v1/attendance.py`

---

### ⑫ 評価入力（企業側）

**URL**: `/company/evaluations`, `/company/evaluations/[id]`

**実装状況**: 🔄 部分的実装（UIのみ、API未実装）

**機能**:
- スタッフの評価入力（技術、対応、清潔感など）
- コメント入力
- 評価送信

**TODO**:
- 評価API (`/api/v1/evaluations`) の実装

---

## 📦 実装済み機能一覧

### ✅ フロントエンド

#### 管理画面（オリエンタルシナジー）
- ✅ ダッシュボード
- ✅ 企業管理（一覧、詳細、登録、編集、契約更新）
- ✅ スタッフ管理（一覧、詳細、検索）
- ✅ 予約管理（一覧、詳細、登録、編集）
- ✅ 勤怠管理

#### 企業側画面
- ✅ ダッシュボード
- ✅ 企業情報管理
- ✅ 社員管理（一覧、詳細、登録、編集、LINE連携）
- ✅ 予約管理（一覧、詳細、登録）
- ✅ **予約登録（社員用）** ★NEW★
- ✅ スタッフ検索
- 🔄 評価入力（UIのみ）

#### 派遣スタッフ側画面
- ✅ ダッシュボード
- ✅ 業務一覧
- ✅ オファー確認
- ✅ マイページ
- ✅ シフト

### ✅ バックエンド

#### API実装
- ✅ 認証API（JWT）
- ✅ ユーザー管理API
- ✅ 企業管理API（CRUD + 契約更新）
- ✅ スタッフ管理API
- ✅ 予約管理API（CRUD）
- ✅ **予約への社員登録API** ★NEW★
- ✅ 勤怠管理API
- 🔄 アサイン管理API（未実装）
- 🔄 評価API（未実装）

#### データベース
- ✅ ユーザーテーブル（users）
- ✅ 企業テーブル（companies）
- ✅ スタッフテーブル（staff）
- ✅ 予約テーブル（reservations）
- ✅ 勤怠テーブル（attendance）
- 🔄 アサインテーブル（assignments）- 未実装
- 🔄 評価テーブル（evaluations）- 未実装

---

## 🎉 今回の実装内容（社員向け予約登録機能）

### ✨ 新規作成ファイル

1. **`frontend/src/app/company/employee-bookings/page.tsx`**
   - 社員向け予約登録画面
   - 募集中の予約一覧表示
   - 予約詳細モーダル
   - 登録フォームモーダル

### 📝 修正ファイル

2. **`frontend/src/components/layout/CompanySidebar.tsx`**
   - メニューに「予約登録（社員用）」を追加

3. **`frontend/src/lib/api.ts`**
   - `EmployeeRegistration` インターフェース追加
   - `reservationsApi.addEmployee()` メソッド追加

4. **`backend/app/schemas/reservation.py`**
   - `EmployeeRegistration` スキーマ追加

5. **`backend/app/api/v1/reservations.py`**
   - `add_employee_to_reservation()` エンドポイント追加
   - `POST /reservations/{reservation_id}/employees`

---

## 🚀 使い方

### 管理者（オリエンタルシナジー）

1. ログイン後、管理画面ダッシュボードへ
2. 「企業管理」から企業を選択し、「予約登録」ボタンをクリック
3. 訪問日程を入力して予約を作成
4. 「予約管理」で予約一覧を確認

### 企業側管理者

1. ログイン後、企業側ダッシュボードへ
2. 「予約管理」で予約を確認
3. 「社員管理」で社員にLINE通知やメールで周知

### 企業側社員（個人）

1. ログイン後、サイドバーから「予約登録（社員用）」をクリック
2. 募集中の予約一覧を確認
3. 希望する予約の「詳細を見る」で内容確認
4. 「登録する」ボタンをクリック
5. 登録フォームに社員情報（氏名、部署など）を入力
6. 「登録する」ボタンで完了

### 派遣スタッフ

1. ログイン後、スタッフ側ダッシュボードへ
2. 「業務一覧」または「オファー確認」で業務を確認
3. 「受諾する」または「辞退する」を選択

---

## 🔧 今後の拡張予定

### 優先度：高

1. **アサイン管理機能の実装**
   - スタッフへのアサイン処理
   - 受諾・辞退機能
   - 再アサイン処理

2. **評価機能の実装**
   - 企業側からの評価入力
   - スタッフプロフィールへの反映
   - 評価統計の表示

3. **通知機能の強化**
   - LINE通知の実装
   - メール通知の実装
   - プッシュ通知

### 優先度：中

4. **カレンダー表示**
   - 予約一覧のカレンダービュー
   - スタッフのスケジュール管理

5. **レポート機能**
   - 利用実績レポート
   - スタッフ稼働レポート
   - 評価統計レポート

### 優先度：低

6. **請求書管理**
   - 請求書の自動生成
   - 支払い状況管理

7. **多言語対応**
   - 英語、中国語などの多言語サポート

---

## 📞 サポート

システムに関するご質問やバグ報告は、以下までご連絡ください：

- 開発チーム: dev@orientalsynergy.jp
- ドキュメント: `/docs` フォルダ内の各種ガイド

---

**最終更新**: 2026年1月8日
**バージョン**: v1.0.0






