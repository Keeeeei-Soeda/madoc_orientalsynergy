# 動作確認手順書

Oriental Synergy 派遣業務管理システムの一連のフローを確認するための手順書です。

---

## 📊 現在の進捗状況

| ステップ   | 内容                             | 状態                  |
| ---------- | -------------------------------- | --------------------- |
| ステップ 1 | 管理者が予約を作成               | ✅ 完了・動作確認済み |
| ステップ 2 | 企業側で従業員をアサイン         | ✅ 完了・動作確認済み |
| ステップ 3 | 管理者がスタッフにオファーを送る | 🔄 **次のステップ**   |
| ステップ 4 | スタッフがオファーを受ける       | ⏳ 未実施             |
| ステップ 5 | 予約にスタッフがアサインされる   | ⏳ 未実施             |
| ステップ 6 | スタッフが勤怠打刻を行う         | ⏳ 未実施             |
| ステップ 7 | 企業がスタッフを評価する         | ⏳ 未実施             |
| ステップ 8 | 評価をスタッフと管理者が確認する | ⏳ 未実施             |

**最終更新**: 2026-01-22

---

## 🎯 確認する流れ

1. ✅ 管理者が予約を作る
2. ✅ 企業側で社員の予約を取る（従業員をアサイン）
3. 🔄 管理者がスタッフにオファーを送る ← **現在ここ**
4. スタッフがオファーを受ける
5. 予約にスタッフがアサインされる
6. 予約当日に、スタッフが勤怠打刻を行う
7. 企業がスタッフを評価する
8. 評価をスタッフと管理者が確認する

---

## 📋 事前準備

### ログイン情報

**管理者アカウント**

- URL: http://localhost:3000/login
- Email: `admin@example.com`
- Password: `password123`

**企業アカウント（株式会社 A）**

- URL: http://localhost:3000/login
- Email: `company1@example.com`
- Password: `password123`

**スタッフアカウント（山田花子）**

- URL: http://localhost:3000/login
- Email: `staff1@example.com`
- Password: `password123`

**スタッフアカウント（鈴木健太）**

- URL: http://localhost:3000/login
- Email: `staff3@example.com`
- Password: `password123`

**スタッフアカウント（高橋愛）**

- URL: http://localhost:3000/login
- Email: `staff4@example.com`
- Password: `password123`

---

## ステップ 1: 管理者が予約を作成

### 手順

1. **管理者でログイン**

   - Email: `admin@example.com`
   - Password: `password123`

2. **予約管理画面に移動**

   - 左サイドバー → 「予約管理」をクリック
   - または URL: http://localhost:3000/admin/reservations

3. **新規予約ボタンをクリック**

   - 右上の「新規予約」ボタンをクリック

4. **予約情報を入力**

   ```
   【基本情報】
   - 企業: 株式会社A（company1）
   - 事業所名: 梅田事業所
   - 住所: 大阪府大阪市北区梅田1-1-1

   【日時】
   - 予約日: 2025/01/25（任意の日付）
   - 開始時間: 10:00
   - 終了時間: 18:00

   【時間枠設定】
   - 施術時間: 60分
   - 休憩時間: 15分
   - 時給: 3000円
   - 枠数: 2枠（自動計算される）

   【その他】
   - 募集期限: 2025/01/24
   - 要望事項: テスト予約です
   ```

5. **予約を作成**

   - 「予約を作成」ボタンをクリック
   - 成功メッセージが表示されることを確認

6. **予約 ID をメモ**
   - 予約一覧画面に戻り、作成した予約の ID をメモ
   - 例: 予約 ID #5

**✅ ステップ 1 完了！**

---

## ステップ 2: 企業側で従業員をアサイン

### 手順

1. **企業アカウントでログイン**

   - ログアウトして企業アカウントでログイン
   - Email: `company1@example.com`
   - Password: `password123`

2. **予約管理画面に移動**

   - 左サイドバー → 「予約管理」をクリック

3. **作成した予約をクリック**

   - 先ほど作成した予約（ID #5 など）をクリック

4. **時間枠を確認**

   - 「時間枠」セクションに 2 つの枠が表示されていることを確認
   - 枠 1: 10:00-11:15（60 分）- 報酬: ¥3,000
   - 枠 2: 11:15-12:30（60 分）- 報酬: ¥3,000

5. **従業員を選択**

   - 枠 1 の「社員を選択」ボタンをクリック
   - モーダルから従業員を選択（例: 田中一郎）
   - 「アサイン」ボタンをクリック

6. **2 つ目の枠にも従業員をアサイン**

   - 枠 2 の「社員を選択」ボタンをクリック
   - 別の従業員を選択（例: 佐藤二郎）
   - 「アサイン」ボタンをクリック

7. **アサイン完了を確認**
   - 各枠に従業員名が表示されていることを確認
   - 残り枠数が正しく更新されていることを確認（例: 2 枠中 2 枠埋まったら「残り 0 枠」）
   - アサイン済みの枠のボタンが「アサイン解除」に変わっていることを確認

**✅ ステップ 2 完了！**

---

## ステップ 3: 管理者がスタッフにオファーを送る 🔄

**← 現在このステップをテスト中**

### 手順

1. **管理者アカウントでログイン**

   - Email: `admin@example.com`
   - Password: `password123`

2. **予約詳細画面に移動**

   - 予約管理 → 該当の予約をクリック

3. **スタッフにオファー送信ボタンをクリック**

   - 「スタッフアサイン状況」セクションの「スタッフにオファー送信」ボタンをクリック

4. **スタッフを選択**

   - モーダルが開く
   - 「山田花子」のチェックボックスをクリック
   - （複数選択可能）

5. **枠を指定（オプション）**

   - 特定の枠にアサインしたい場合は、時間枠セクションの「スタッフをアサイン」ボタンから送信
   - 今回は全体オファーで進める

6. **オファーを送信**

   - 「選択したスタッフにオファー送信」ボタンをクリック
   - 確認ダイアログで「OK」

7. **オファー送信完了を確認**
   - 「回答待ち」セクションに山田花子が表示されることを確認

---

## ステップ 4: スタッフがオファーを受ける

### 手順（3 人のスタッフで確認）

募集番号 25 の案件には、以下の 3 人にオファーが送信されています：

- 山田花子（staff1@example.com）
- 鈴木健太（staff3@example.com）
- 高橋愛（staff4@example.com）

#### A. 山田花子でオファーを受諾

1. **山田花子アカウントでログイン**

   - Email: `staff1@example.com`
   - Password: `password123`

2. **ダッシュボードを確認**

   - 「新しいオファー」に 1 件表示されることを確認

3. **オファー一覧画面に移動**

   - 「オファー確認」ボタンをクリック
   - または URL: http://localhost:3000/staff/jobs/offers

4. **オファー詳細を確認**

   - オファーカードの「詳細・回答」ボタンをクリック

5. **オファー内容を確認**

   - 予約情報（日時、場所、報酬など）を確認
   - 予想報酬が表示されることを確認

6. **オファーを受諾**

   - 「オファーを受諾」ボタンをクリック
   - 確認ダイアログで「OK」

7. **受諾完了を確認**
   - 「オファーを受諾しました」というメッセージが表示される
   - オファー一覧画面に戻る

#### B. 鈴木健太でオファーを受諾

1. **ログアウトして鈴木健太でログイン**

   - Email: `staff3@example.com`
   - Password: `password123`

2. **同様の手順でオファーを受諾**

   - ダッシュボード → オファー確認 → 受諾

3. **確定数が上限（2 枠）に達したことを確認**

#### C. 高橋愛でオファーを受諾（上限超過のテスト）

1. **ログアウトして高橋愛でログイン**

   - Email: `staff4@example.com`
   - Password: `password123`

2. **オファーを受諾しようとする**

   - オファー確認 → 受諾ボタンをクリック

3. **エラーメッセージを確認**
   - 「確定数が上限に達しています。上限: 2 人、現在の確定数: 2 人」というエラーが表示されることを確認
   - これにより、確定数の上限チェックが正しく動作していることを確認

---

## ステップ 5: 予約にスタッフがアサインされたことを確認

### 手順

1. **管理者画面で確認**

   - 管理者アカウントでログイン
   - 予約詳細画面を開く
   - 「確定済み」セクションに山田花子が表示されることを確認

2. **スタッフ画面で確認**
   - スタッフアカウントでログイン
   - 「シフト管理」をクリック（URL: http://localhost:3000/staff/shifts）
   - 確定業務一覧に該当の予約が表示されることを確認

---

## ステップ 6: スタッフが勤怠打刻を行う

### 手順

**※ テストモード: 日付に関係なく打刻できます**

1. **スタッフアカウントでログイン**

   - Email: `staff1@example.com`
   - Password: `password123`

2. **勤怠管理画面に移動**

   - 左サイドバー → 「勤怠管理」をクリック
   - または URL: http://localhost:3000/staff/attendance

3. **出勤打刻**

   - 「確定済み勤務」セクションに該当の業務が表示される
   - 「出勤打刻」ボタンをクリック
   - 「出勤打刻が完了しました」というメッセージを確認

4. **退勤打刻**

   - ページがリロードされ、出勤時刻が表示される
   - 「退勤打刻」ボタンをクリック
   - 「退勤打刻が完了しました」というメッセージを確認

5. **完了報告**

   - 完了報告モーダルが自動的に開く
   - 報告内容を入力:
     ```
     本日の施術を完了しました。
     2名の従業員様に対して、肩・腰のマッサージを実施しました。
     特に問題なく完了しております。
     ```
   - 「送信」ボタンをクリック

6. **完了確認**
   - 勤怠履歴に該当の勤怠が「完了」ステータスで表示されることを確認

---

## ステップ 7: 企業がスタッフを評価する

### 手順

1. **企業アカウントでログイン**

   - Email: `company1@example.com`
   - Password: `password123`

2. **予約管理画面に移動**

   - 左サイドバー → 「予約管理」をクリック

3. **該当の予約をクリック**

   - 予約詳細画面を開く

4. **評価ページに移動**

   - 「スタッフを評価」ボタンをクリック
   - または URL: http://localhost:3000/company/reservations/{id}/evaluate
   - ※ ボタンがない場合は、URL を直接入力

5. **評価を入力**

   - 山田花子さんの評価フォームが表示される

   **各項目を星で評価（1-5）**

   - 清潔感: ★★★★★（5）
   - 対応力: ★★★★★（5）
   - 満足度: ★★★★★（5）
   - 時間厳守: ★★★★★（5）
   - 技術力: ★★★★☆（4）
   - 総合評価: 4.8（自動計算）

   **コメント入力（必須）**

   ```
   とても丁寧な施術で、従業員からも好評でした。
   時間厳守で、コミュニケーションも円滑でした。
   また次回もお願いしたいと思います。
   ```

6. **評価を送信**

   - 「評価を送信」ボタンをクリック
   - 確認ダイアログで「OK」

7. **送信完了を確認**
   - 「評価を送信しました」というメッセージが表示される
   - 予約詳細画面に戻る

---

## ステップ 8: 評価をスタッフと管理者が確認する

### A. スタッフ側で確認

1. **スタッフアカウントでログイン**

   - Email: `staff1@example.com`
   - Password: `password123`

2. **ダッシュボードで確認**

   - 評価サマリーが更新されていることを確認
   - 平均評価: 4.8
   - 今月の収入予定に該当の報酬が含まれていることを確認

3. **評価一覧画面に移動**

   - 左サイドバー → 「評価確認」をクリック
   - または URL: http://localhost:3000/staff/evaluations

4. **評価サマリーを確認**

   - 総合評価: 4.8
   - 評価数: 1
   - 項目別平均が表示されることを確認

5. **評価詳細を確認**
   - 評価履歴テーブルに該当の評価が表示される
   - 各項目の点数を確認
   - 「表示」ボタンをクリックしてコメントを確認

### B. 管理者側で確認

1. **管理者アカウントでログイン**

   - Email: `admin@example.com`
   - Password: `password123`

2. **予約詳細画面で確認**

   - 予約管理 → 該当の予約をクリック
   - スタッフアサイン状況を確認
   - （必要に応じて評価情報も表示）

3. **スタッフ管理画面で確認**
   - 左サイドバー → 「スタッフ管理」をクリック
   - 山田花子の平均評価が更新されていることを確認

---

## 🎉 動作確認完了！

全てのステップが正常に完了すれば、以下の流れが確認できたことになります：

✅ 管理者による予約作成
✅ 企業による従業員アサイン
✅ 管理者によるスタッフへのオファー送信
✅ スタッフによるオファー受諾
✅ スタッフのアサイン確定
✅ スタッフによる勤怠打刻・完了報告
✅ 企業によるスタッフ評価
✅ 評価の確認（スタッフ・管理者）

---

## 📝 補足情報

### テストモードについて

現在、以下の機能はテストモードになっています：

1. **勤怠管理**

   - 日付に関係なく全ての確定済み業務で打刻可能
   - 「テストモード」バッジが表示されます

2. **評価機能**
   - 予約日に関係なく評価入力可能

### データのリセット

テストデータをリセットしたい場合：

```bash
cd /Users/soedakei/madoc_line/backend
python seed_data.py
```

### トラブルシューティング

**問題**: ボタンが表示されない

- ブラウザをリロード（Cmd + R / Ctrl + R）

**問題**: 「権限がありません」エラー

- 正しいアカウントでログインしているか確認
- ログアウトして再ログイン

**問題**: オファーが表示されない

- 管理者画面でオファーが「pending」ステータスか確認
- スタッフ ID が正しいか確認

**問題**: 従業員をアサインしても枠数が更新されない

- ✅ 修正済み: データベース更新とフロントエンドの再取得ロジックを改善
- 手動更新: 「データを更新」ボタンをクリック
- ページをリロード（Cmd + R / Ctrl + R）

**問題**: 従業員登録後に予約詳細画面に戻ってこない

- ✅ 修正済み: 従業員登録後に自動的に予約詳細画面に戻るように実装
- 予約詳細画面の「従業員の登録をする」ボタンから登録すると、登録後に元の画面に戻ります

**問題**: 予約枠数と募集人数が一致しない

- ✅ 修正済み: `max_participants`（募集人数）を考慮した枠数計算に変更
- 時間的に可能な枠数と募集人数の小さい方が表示されるようになりました
- 例: 8 時間の予約で 6 枠可能でも、募集人数 2 名なら 2 枠のみ表示

---

## 🔗 関連 URL

- **管理者ダッシュボード**: http://localhost:3000/admin/dashboard
- **企業ダッシュボード**: http://localhost:3000/company/dashboard
- **スタッフダッシュボード**: http://localhost:3000/staff/dashboard
- **API ドキュメント**: http://localhost:8000/api/docs

---

## 🔧 実装済み改善点（2026-01-22）

### ステップ 1-2 で解決した問題

**1. 従業員割り当て時の権限エラー（403 Forbidden）**

- **問題**: 企業アカウントが従業員を枠に割り当てようとすると 403 エラーが発生
- **原因**: バックエンドの権限チェックロジックでユーザー ID と企業 ID を直接比較していた
- **解決**: 企業ユーザーの所属企業を正しく取得して比較するように修正

**2. 従業員登録時の 422 バリデーションエラー**

- **問題**: 従業員登録フォームで必須フィールドや空文字列の扱いでエラー
- **原因**: フロントエンドとバックエンドのフィールド名不一致、空文字列の扱い
- **解決**: フィールド名を統一し、オプションフィールドの空文字列を`undefined`に変換

**3. データ更新の問題**

- **問題**: 従業員をアサインしても、残り枠数が更新されない、ボタンが押せたまま
- **原因**:
  - SQLAlchemy が JSON フィールドの変更を検知できなかった
  - フロントエンドのデータ再取得タイミングが不適切
- **解決**:
  - `flag_modified`を使用して JSON 変更を明示的にマーク
  - ページの可視性イベント、URL パラメータ、手動更新ボタンなど複数の再取得トリガーを実装

**4. 予約枠数と募集人数の不整合**

- **問題**: 予約一覧で「空き 2 枠」なのに詳細画面で「6 枠」表示される
- **原因**:
  - 物理的な時間枠（`slot_count`）と募集人数（`max_participants`）が分離されていなかった
  - 予約一覧と詳細画面で異なるロジックで空き枠を計算していた
- **解決**:
  - 時間枠計算時に`max_participants`を考慮するように修正
  - 既存データを修正するマイグレーションスクリプトを実行
  - 予約一覧と詳細画面で統一された枠数表示ロジックを使用

**5. 従業員登録後の UX 改善**

- **問題**: 従業員登録後に予約詳細画面に戻ってこない
- **解決**:
  - 予約詳細画面に「従業員の登録をする」ボタンを追加
  - 登録後に元の予約詳細画面に自動的に戻り、データを更新

### 現在の実装状態

✅ 予約作成機能 - 完全動作
✅ 従業員管理機能 - 完全動作
✅ 従業員アサイン機能 - 完全動作
✅ データ自動更新 - 完全動作
⏳ スタッフオファー機能 - 次のテスト対象

---

作成日: 2026-01-22
最終更新: 2026-01-22
