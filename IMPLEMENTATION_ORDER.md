# 実装順序とデバッグ計画

## 📋 推奨実装順序

### ✅ 正しい順序: デバッグ完了後にアカウント発行

```
1. 実装
   ↓
2. テスト・デバッグ（テスト用アカウントで）
   ↓
3. 本番環境へのデプロイ
   ↓
4. 社員用アカウントの発行（本番運用開始）
```

---

## 🎯 各フェーズの詳細

### Phase 1: 実装（開発環境）

**期間**: 約2.5日（20時間）

#### 1-1. バックエンド実装
- [ ] UserRoleにEMPLOYEEを追加
- [ ] マイグレーション実行
- [ ] 社員参加登録API実装
- [ ] 社員アカウント作成API実装
- [ ] 権限チェック関数追加

#### 1-2. フロントエンド実装
- [ ] AuthContextの更新（EMPLOYEEロール追加）
- [ ] 社員用レイアウト作成
- [ ] employee-bookingsページの移動と修正
- [ ] APIクライアントの追加
- [ ] ログイン後のリダイレクト処理更新

#### 1-3. 管理者画面の更新
- [ ] 企業詳細ページに社員アカウント作成ボタン追加
- [ ] アカウント作成モーダルの実装

---

### Phase 2: テスト・デバッグ（開発環境）

**期間**: 約1日（4-6時間）

#### 2-1. テスト用アカウントの作成

**開発環境でテスト用の社員アカウントを作成**

```sql
-- テスト用企業
INSERT INTO companies (name, ...) VALUES ('テスト企業', ...);

-- テスト用社員アカウント
INSERT INTO users (
  email,
  password_hash,
  name,
  role,
  company_id,
  is_active
) VALUES (
  'test-employee@example.com',
  '$2b$12$...',  -- パスワード: test123
  'テスト企業（社員用）',
  'employee',
  1,  -- テスト企業のID
  true
);
```

#### 2-2. テスト項目

**✅ 基本機能テスト**

| テスト項目 | 確認内容 | ステータス |
|-----------|---------|-----------|
| ログイン | 社員アカウントでログインできる | ⬜ |
| リダイレクト | ログイン後、/employee/bookingsへ遷移 | ⬜ |
| 予約一覧表示 | 募集中の予約が表示される | ⬜ |
| 予約詳細表示 | 予約の詳細情報が正しく表示される | ⬜ |
| 社員参加登録 | 社員情報を入力して登録できる | ⬜ |
| 募集人数チェック | 満席の予約には登録できない | ⬜ |
| エラーハンドリング | エラー時に適切なメッセージが表示される | ⬜ |

**✅ 権限テスト**

| テスト項目 | 確認内容 | ステータス |
|-----------|---------|-----------|
| アクセス制限 | /employee/bookings以外はアクセス不可 | ⬜ |
| 他社の予約 | 他社の予約は表示されない | ⬜ |
| 他社の予約登録 | 他社の予約には登録できない | ⬜ |
| 管理者画面 | 管理者画面にアクセスできない | ⬜ |
| 企業画面 | 企業側の他のページにアクセスできない | ⬜ |

**✅ UI/UXテスト**

| テスト項目 | 確認内容 | ステータス |
|-----------|---------|-----------|
| レスポンシブ | スマホ・タブレット・PCで正常表示 | ⬜ |
| ローディング | データ取得中の表示が適切 | ⬜ |
| エラーメッセージ | エラー時のメッセージが分かりやすい | ⬜ |
| フォームバリデーション | 必須項目のチェックが機能する | ⬜ |

#### 2-3. デバッグチェックリスト

**🔍 よくある問題と対処法**

| 問題 | 原因 | 対処法 |
|------|------|--------|
| ログインできない | パスワードハッシュ不一致 | パスワード再設定 |
| リダイレクトループ | AuthGuardの設定ミス | ロールチェックを確認 |
| 予約が表示されない | APIの権限チェック | company_idのフィルタリング確認 |
| 登録が失敗する | APIエンドポイント未実装 | バックエンドAPIを確認 |
| 他社の予約が見える | データ分離の不備 | company_idでのフィルタリング確認 |

#### 2-4. ログ確認

**バックエンドログ**
```bash
# エラーログを確認
tail -f backend/logs/error.log

# APIリクエストログを確認
tail -f backend/logs/access.log
```

**フロントエンドログ**
```javascript
// ブラウザのコンソールで確認
console.log('API Response:', response)
console.error('Error:', error)
```

---

### Phase 3: 本番環境へのデプロイ

**期間**: 約0.5日（2-3時間）

#### 3-1. デプロイ前チェックリスト

- [ ] 環境変数の設定確認
- [ ] データベースマイグレーション実行
- [ ] 本番環境のAPIエンドポイント確認
- [ ] SSL証明書の確認（HTTPS必須）
- [ ] エラーログの設定確認

#### 3-2. デプロイ手順

```bash
# 1. バックエンドのデプロイ
cd backend
git pull origin main
pip install -r requirements.txt
alembic upgrade head
systemctl restart backend-service

# 2. フロントエンドのデプロイ
cd frontend
git pull origin main
npm install
npm run build
pm2 restart frontend
```

#### 3-3. デプロイ後の確認

- [ ] ヘルスチェックエンドポイントが正常
- [ ] ログイン機能が動作
- [ ] APIが正常に応答
- [ ] エラーログに異常がない

---

### Phase 4: 社員用アカウントの発行（本番運用開始）

**期間**: 各企業ごとに約30分

#### 4-1. アカウント作成手順

**管理者が企業詳細ページから作成**

```
1. 管理者が企業詳細ページにアクセス
   /admin/companies/{company_id}
   ↓
2. 「社員用アカウントを作成」ボタンをクリック
   ↓
3. パスワードを設定
   （推奨: ランダムな強力なパスワード）
   ↓
4. アカウント作成完了
   ↓
5. アカウント情報を企業担当者に通知
   - メールアドレス
   - パスワード
   - ログインURL
```

#### 4-2. アカウント情報の通知

**通知内容のテンプレート**

```
件名: 社員用予約登録アカウントの発行について

{企業名} 様

社員用予約登録アカウントを発行いたしました。

【アカウント情報】
メールアドレス: company_{企業ID}_employees@example.com
パスワード: {パスワード}
ログインURL: https://your-domain.com/login

【使い方】
1. 上記URLにアクセス
2. メールアドレスとパスワードでログイン
3. 予約登録ページで社員情報を入力して登録

【注意事項】
- このアカウントは社員全員で共有してください
- パスワードは定期的に変更することを推奨します
- 不明な点がございましたら、お気軽にお問い合わせください

Oriental Synergy
```

#### 4-3. 社員への案内

**企業担当者が社員に案内**

```
社員の皆様へ

予約登録システムの社員用アカウントが発行されました。

【ログイン方法】
1. 以下のURLにアクセス
   https://your-domain.com/login

2. 以下の情報でログイン
   メールアドレス: company_1_employees@example.com
   パスワード: {共有パスワード}

3. 予約登録ページで、あなたの情報を入力して登録してください

【登録時に必要な情報】
- 氏名
- 部署
- 役職（任意）
- 電話番号（任意）
- メールアドレス（任意）

ご不明な点がございましたら、総務部までお問い合わせください。
```

---

## ⚠️ 重要な注意点

### ❌ やってはいけないこと

1. **デバッグ前に本番アカウントを発行**
   - バグがある状態でアカウントを発行すると、ユーザーが混乱する
   - セキュリティリスクがある

2. **テスト用アカウントを本番で使用**
   - テスト用のパスワードは弱い可能性がある
   - テストデータが混在する

3. **一斉に全企業のアカウントを発行**
   - まず1社でテストしてから、段階的に展開
   - 問題があれば早期に発見できる

### ✅ 推奨されること

1. **段階的な展開**
   ```
   1社目: テスト企業で動作確認
   ↓
   2-3社目: パイロット運用
   ↓
   全社展開
   ```

2. **ロールバック計画**
   - 問題が発生した場合の対応手順を準備
   - アカウントの無効化手順を確認

3. **サポート体制**
   - 企業担当者への問い合わせ窓口を準備
   - FAQを作成

---

## 📊 実装スケジュール例

### 1週間スケジュール

| 日 | フェーズ | 内容 | 担当 |
|---|---------|------|------|
| 月 | Phase 1 | バックエンド実装 | 開発者 |
| 火 | Phase 1 | フロントエンド実装 | 開発者 |
| 水 | Phase 1 | 管理者画面更新 | 開発者 |
| 木 | Phase 2 | テスト・デバッグ | 開発者 + QA |
| 金 | Phase 3 | 本番デプロイ | 開発者 + インフラ |
| 翌週 | Phase 4 | アカウント発行（段階的） | 管理者 |

---

## 🔍 デバッグ時の確認ポイント

### 1. ログイン機能

```typescript
// テストケース
✅ 正しいメールアドレス + パスワード → ログイン成功
✅ 間違ったパスワード → エラーメッセージ表示
✅ 存在しないメールアドレス → エラーメッセージ表示
✅ ログイン後、正しいページへリダイレクト
```

### 2. 予約一覧表示

```typescript
// テストケース
✅ 自社の募集中予約が表示される
✅ 他社の予約は表示されない
✅ 満席の予約も表示される（登録ボタンは非表示）
✅ ローディング中はスピナーが表示される
✅ エラー時は適切なメッセージが表示される
```

### 3. 社員参加登録

```typescript
// テストケース
✅ 必須項目を入力して登録成功
✅ 必須項目未入力でエラー表示
✅ 募集人数に達している予約には登録できない
✅ 登録後、予約一覧が更新される
✅ 登録済み社員名が正しく表示される
```

### 4. 権限チェック

```typescript
// テストケース
✅ /employee/bookings にアクセス可能
✅ /company/dashboard にアクセス不可（リダイレクト）
✅ /admin/dashboard にアクセス不可（リダイレクト）
✅ /staff/dashboard にアクセス不可（リダイレクト）
```

---

## 📝 デバッグ完了の判断基準

### ✅ デバッグ完了の条件

1. **すべてのテストケースがパス**
   - 基本機能テスト: 100%パス
   - 権限テスト: 100%パス
   - UI/UXテスト: 100%パス

2. **エラーログに異常がない**
   - 本番環境のエラーログを確認
   - 警告レベルのログも確認

3. **パフォーマンスが問題ない**
   - ページ読み込み時間: 3秒以内
   - API応答時間: 1秒以内

4. **セキュリティチェック完了**
   - 権限チェックが正しく機能
   - データ分離が正しく機能
   - SQLインジェクション対策確認

5. **ドキュメント整備完了**
   - 運用マニュアル作成
   - トラブルシューティングガイド作成

---

## 🚀 本番運用開始の判断

### ✅ 本番運用開始OKの条件

- [ ] デバッグ完了（上記の条件をすべて満たす）
- [ ] 本番環境へのデプロイ完了
- [ ] 本番環境での動作確認完了
- [ ] サポート体制の準備完了
- [ ] 企業担当者への案内文作成完了

### 📧 運用開始の通知

```
件名: 社員用予約登録システムの運用開始について

{企業名} 様

社員用予約登録システムの準備が整いました。
本日より運用を開始いたします。

【運用開始日】
{日付}

【アカウント情報】
{アカウント情報}

【サポート】
不明な点がございましたら、以下までお問い合わせください。
Email: support@orientalsynergy.com
Tel: 06-XXXX-XXXX

Oriental Synergy
```

---

## 📊 まとめ

### ✅ 推奨順序

```
1. 実装（開発環境）
   ↓
2. テスト・デバッグ（開発環境 + テスト用アカウント）
   ↓
3. 本番環境へのデプロイ
   ↓
4. 本番環境での最終確認
   ↓
5. 社員用アカウントの発行（段階的）
```

### ⏱️ 期間見積もり

| フェーズ | 期間 |
|---------|------|
| Phase 1: 実装 | 2.5日 |
| Phase 2: テスト・デバッグ | 1日 |
| Phase 3: デプロイ | 0.5日 |
| Phase 4: アカウント発行 | 各企業30分 |
| **合計** | **約4日** |

### 🎯 重要なポイント

1. **デバッグ完了後にアカウント発行**
   - バグ修正が完了してから
   - 本番環境で動作確認してから

2. **段階的な展開**
   - まず1社でテスト
   - 問題なければ全社展開

3. **サポート体制の準備**
   - 問い合わせ窓口の準備
   - FAQの作成

---

最終更新日: 2026年1月23日

